syntax = "proto3";

package stream_mount_api;

option go_package = "github.com/sushydev/stream_mount_api/gen/go/stream_mount_api";

service FileSystemService {
	rpc Root(RootRequest) returns (RootResponse);
	rpc ReadDirAll(ReadDirAllRequest) returns (ReadDirAllResponse);
	rpc Lookup(LookupRequest) returns (LookupResponse);
	rpc Create(CreateRequest) returns (CreateResponse);
	rpc Mkdir(MkdirRequest) returns (MkdirResponse);
	rpc Remove(RemoveRequest) returns (RemoveResponse);
	rpc Rename(RenameRequest) returns (RenameResponse);
	rpc Link(LinkRequest) returns (LinkResponse);
	rpc Setattr(SetattrRequest) returns (SetattrResponse);

	rpc ReadFile(ReadFileRequest) returns (ReadFileResponse);
	rpc WriteFile(WriteFileRequest) returns (WriteFileResponse);

	rpc GetFileInfo(GetFileInfoRequest) returns (GetFileInfoResponse);
	rpc GetStreamUrl(GetStreamUrlRequest) returns (GetStreamUrlResponse);
}

message RootRequest {}

message RootResponse {
	Node root = 1;
}

message ReadDirAllRequest {
	uint64 node_id = 1;
}

message ReadDirAllResponse {
	repeated Node nodes = 1;
}

message LookupRequest {
	uint64 node_id = 1;
	string name = 2;
}

message LookupResponse {
	optional Node node = 1;
}
message CreateRequest {
	uint64 parent_node_id = 1;
	string name = 2;
	uint32 mode = 3;
}

message CreateResponse {
	Node node = 1;
}

message MkdirRequest {
	uint64 parent_node_id = 1;
	string name = 2;
}

message MkdirResponse {
	Node node = 1;
}

message RemoveRequest {
	uint64 parent_node_id = 1;
	string name = 2;
}

message RemoveResponse {}

message RenameRequest {
	uint64 old_parent_node_id = 1;
	string old_name = 2;
	uint64 new_parent_node_id = 3;
	string new_name = 4;
}

message RenameResponse {
	Node node = 1;
}

message LinkRequest {
	uint64 node_id = 1;
	uint64 parent_node_id = 2;
	string name = 3;
}

message LinkResponse {
	Node node = 1;
}

message SetattrRequest {
	uint64 node_id = 1;
	optional uint32 mode = 2;
	optional uint64 size = 3;
	optional uint64 atime = 4;  // seconds since epoch
	optional uint32 atime_nsec = 5;  // nanoseconds
	optional uint64 mtime = 6;  // seconds since epoch
	optional uint32 mtime_nsec = 7;  // nanoseconds
	optional uint32 uid = 8;
	optional uint32 gid = 9;
}

message SetattrResponse {
	Node node = 1;
}

message GetFileInfoRequest {
	uint64 node_id = 1;
}

message GetFileInfoResponse {
	uint64 size = 1;
	uint32 mode = 2;
	uint64 atime = 3;  // seconds since epoch
	uint32 atime_nsec = 4;  // nanoseconds
	uint64 mtime = 5;  // seconds since epoch
	uint32 mtime_nsec = 6;  // nanoseconds
	uint64 ctime = 7;  // seconds since epoch
	uint32 ctime_nsec = 8;  // nanoseconds
	uint32 uid = 9;
	uint32 gid = 10;
	uint32 nlink = 11;  // number of hard links
}

message GetStreamUrlRequest {
	uint64 node_id = 1;
}

message GetStreamUrlResponse {
	optional string url = 1;
}

message ReadFileRequest {
	uint64 node_id = 1;
	uint64 offset = 2;
	uint64 size = 3;
}

message ReadFileResponse {
	bytes data = 1;
}

message WriteFileRequest {
	uint64 node_id = 1;
	uint64 offset = 2;
	bytes data = 3;
}

message WriteFileResponse {
	uint64 bytes_written = 1;
}

message Node {
	uint64 id = 1;
	string name = 2;
	uint32 mode = 3;  // Unix file mode including type bits (S_IFDIR, S_IFREG, etc.)
	bool streamable = 4;
	uint64 size = 5;
	uint64 atime = 6;  // seconds since epoch
	uint32 atime_nsec = 7;  // nanoseconds
	uint64 mtime = 8;  // seconds since epoch
	uint32 mtime_nsec = 9;  // nanoseconds
	uint64 ctime = 10;  // seconds since epoch
	uint32 ctime_nsec = 11;  // nanoseconds
	uint32 uid = 12;
	uint32 gid = 13;
	uint32 nlink = 14;  // number of hard links
}
