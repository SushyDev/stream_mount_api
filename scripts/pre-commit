#!/usr/bin/env bash

set -e

# Colors for output
RED='\033[0;31m'
readonly RED
GREEN='\033[0;32m'
readonly GREEN
YELLOW='\033[1;33m'
readonly YELLOW
NO_COLOR='\033[0m'
readonly NO_COLOR

echo -e "${YELLOW}Pre-commit: Checking for proto file changes...${NO_COLOR}"

PROTO_CHANGED=$(git diff --staged --name-only | grep -E '\.proto$' || true)
readonly PROTO_CHANGED

if [ -z "$PROTO_CHANGED" ]; then
    echo -e "${GREEN}No proto files changed, skipping generation${NC}"
    exit 0
fi

echo -e "${YELLOW}Proto files changed:${NO_COLOR}"
echo "$PROTO_CHANGED"

echo -e "${YELLOW}Regenerating code...${NO_COLOR}"
if command -v make &> /dev/null; then
    if ! make generate; then
        echo -e "${RED}ERROR: Code generation failed!${NO_COLOR}"
        echo -e "${RED}Please fix the errors and try again.${NO_COLOR}"
        exit 1
    fi
else
    if ! ./scripts/generate.sh; then
        echo -e "${RED}ERROR: Code generation failed!${NO_COLOR}"
        echo -e "${RED}Please fix the errors and try again.${NO_COLOR}"
        exit 1
    fi
fi

echo -e "${YELLOW}Adding generated files to commit...${NO_COLOR}"
git add gen/go gen/elixir

echo -e "${GREEN}âœ“ Code generation complete and added to commit${NO_COLOR}"
exit 0
